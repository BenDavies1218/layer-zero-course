<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 700">
  <!-- Define styles -->
  <defs>
    <style>
      .phase-box { fill: #ecf0f1; stroke: #34495e; stroke-width: 2; }
      .component-box { fill: #3498db; stroke: #2c3e50; stroke-width: 2; }
      .offchain-box { fill: #95a5a6; stroke: #7f8c8d; stroke-width: 2; }
      .box-text { font-family: Arial, sans-serif; font-size: 12px; fill: white; text-anchor: middle; }
      .phase-text { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #2c3e50; }
      .arrow { stroke: #e74c3c; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-label { font-family: Arial, sans-serif; font-size: 10px; fill: #c0392b; }
      .step-num { font-family: Arial, sans-serif; font-size: 10px; fill: white; text-anchor: middle; font-weight: bold; }
      .offchain-label { font-family: Arial, sans-serif; font-size: 9px; fill: #2c3e50; font-style: italic; }
    </style>

    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#e74c3c" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="450" y="30" style="font-family: Arial; font-size: 18px; font-weight: bold; fill: #2c3e50; text-anchor: middle;">Complete Message Lifecycle (3 Phases)</text>

  <!-- PHASE 1: SEND -->
  <rect x="30" y="60" width="250" height="180" rx="5" class="phase-box"/>
  <text x="155" y="85" class="phase-text">PHASE 1: SEND</text>

  <!-- User -->
  <rect x="50" y="100" width="80" height="40" rx="3" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/>
  <text x="90" y="125" class="box-text" font-size="11">User</text>

  <!-- OApp Source -->
  <rect x="180" y="100" width="80" height="40" rx="3" class="component-box"/>
  <text x="220" y="120" class="box-text" font-size="10">OApp</text>
  <text x="220" y="133" class="box-text" font-size="9">(Source)</text>

  <!-- Endpoint Source -->
  <rect x="110" y="170" width="100" height="50" rx="3" class="component-box"/>
  <text x="160" y="192" class="box-text" font-size="10">Endpoint V2</text>
  <text x="160" y="205" class="box-text" font-size="9">(Chain A)</text>

  <!-- Arrows Phase 1 -->
  <path d="M 130 120 L 180 120" class="arrow"/>
  <text x="155" y="115" class="arrow-label">call</text>

  <path d="M 220 140 L 190 170" class="arrow"/>
  <text x="195" y="155" class="arrow-label">_lzSend</text>

  <circle cx="145" cy="120" r="10" fill="#e74c3c"/>
  <text x="145" y="124" class="step-num">1</text>

  <!-- PHASE 2: VERIFY -->
  <rect x="320" y="60" width="250" height="290" rx="5" class="phase-box"/>
  <text x="445" y="85" class="phase-text">PHASE 2: VERIFY</text>

  <!-- PacketSent Event -->
  <rect x="340" y="105" width="100" height="35" rx="3" fill="#9b59b6" stroke="#8e44ad" stroke-width="2"/>
  <text x="390" y="125" class="box-text" font-size="10">PacketSent</text>

  <!-- SendUln302 -->
  <rect x="340" y="160" width="100" height="40" rx="3" class="component-box"/>
  <text x="390" y="183" class="box-text" font-size="10">SendUln302</text>

  <!-- DVN 1 -->
  <rect x="340" y="225" width="80" height="40" rx="3" class="offchain-box"/>
  <text x="380" y="248" class="box-text" font-size="10">DVN 1</text>
  <text x="380" y="273" class="offchain-label">(Off-Chain)</text>

  <!-- DVN 2 -->
  <rect x="450" y="225" width="80" height="40" rx="3" class="offchain-box"/>
  <text x="490" y="248" class="box-text" font-size="10">DVN 2</text>
  <text x="490" y="273" class="offchain-label">(Off-Chain)</text>

  <!-- ReceiveUln302 -->
  <rect x="370" y="295" width="110" height="40" rx="3" class="component-box"/>
  <text x="425" y="318" class="box-text" font-size="10">ReceiveUln302</text>

  <!-- Arrows Phase 2 -->
  <path d="M 390 140 L 390 160" class="arrow"/>
  <path d="M 390 200 L 360 225" class="arrow"/>
  <path d="M 390 200 L 480 225" class="arrow"/>

  <path d="M 380 265 L 400 295" class="arrow"/>
  <path d="M 490 265 L 440 295" class="arrow"/>

  <circle cx="390" cy="110" r="10" fill="#e74c3c"/>
  <text x="390" y="114" class="step-num">2</text>

  <text x="340" y="220" class="arrow-label">watches</text>
  <text x="470" y="288" class="arrow-label">verify</text>

  <!-- PHASE 3: EXECUTE -->
  <rect x="610" y="60" width="250" height="240" rx="5" class="phase-box"/>
  <text x="735" y="85" class="phase-text">PHASE 3: EXECUTE</text>

  <!-- Executor -->
  <rect x="640" y="105" width="90" height="40" rx="3" class="offchain-box"/>
  <text x="685" y="128" class="box-text" font-size="10">Executor</text>
  <text x="685" y="153" class="offchain-label">(Off-Chain)</text>

  <!-- Endpoint Dest -->
  <rect x="760" y="105" width="80" height="50" rx="3" class="component-box"/>
  <text x="800" y="125" class="box-text" font-size="9">Endpoint V2</text>
  <text x="800" y="140" class="box-text" font-size="9">(Chain B)</text>

  <!-- OApp Dest -->
  <rect x="670" y="190" width="130" height="50" rx="3" class="component-box"/>
  <text x="735" y="215" class="box-text" font-size="10">OApp (Destination)</text>
  <text x="735" y="228" class="box-text" font-size="9">_lzReceive()</text>

  <!-- User Dest -->
  <rect x="690" y="260" width="90" height="30" rx="3" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/>
  <text x="735" y="280" class="box-text" font-size="10">State Updated</text>

  <!-- Arrows Phase 3 -->
  <path d="M 730 125 L 760 130" class="arrow"/>
  <text x="735" y="120" class="arrow-label">lzReceive</text>

  <path d="M 790 155 L 745 190" class="arrow"/>
  <text x="755" y="175" class="arrow-label">calls</text>

  <path d="M 735 240 L 735 260" class="arrow"/>

  <circle cx="710" cy="125" r="10" fill="#e74c3c"/>
  <text x="710" y="129" class="step-num">3</text>

  <!-- Cross-Phase Connections -->
  <path d="M 210 195 L 390 125" class="arrow" stroke-dasharray="5,5" stroke="#95a5a6"/>
  <text x="290" y="155" style="font-family: Arial; font-size: 9px; fill: #7f8c8d;">emits event</text>

  <path d="M 480 315 L 650 125" class="arrow" stroke-dasharray="5,5" stroke="#95a5a6"/>
  <text x="550" y="220" style="font-family: Arial; font-size: 9px; fill: #7f8c8d;">verification complete</text>

  <!-- Legend -->
  <g transform="translate(50, 380)">
    <text x="0" y="0" style="font-family: Arial; font-size: 13px; fill: #2c3e50; font-weight: bold;">Three-Phase Flow:</text>

    <rect x="0" y="10" width="15" height="15" fill="#3498db" stroke="#2c3e50"/>
    <text x="20" y="22" style="font-family: Arial; font-size: 11px; fill: #34495e;">On-Chain Components</text>

    <rect x="0" y="30" width="15" height="15" fill="#95a5a6" stroke="#7f8c8d"/>
    <text x="20" y="42" style="font-family: Arial; font-size: 11px; fill: #34495e;">Off-Chain Workers</text>

    <rect x="0" y="50" width="15" height="15" fill="#2ecc71" stroke="#27ae60"/>
    <text x="20" y="62" style="font-family: Arial; font-size: 11px; fill: #34495e;">User/State</text>

    <line x1="250" y1="20" x2="280" y2="20" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="290" y="25" style="font-family: Arial; font-size: 11px; fill: #34495e;">Synchronous Flow</text>

    <line x1="250" y1="40" x2="280" y2="40" stroke="#95a5a6" stroke-width="2" stroke-dasharray="5,5"/>
    <text x="290" y="45" style="font-family: Arial; font-size: 11px; fill: #34495e;">Asynchronous/Cross-Chain</text>
  </g>

  <!-- Key Points -->
  <g transform="translate(50, 520)">
    <text x="0" y="0" style="font-family: Arial; font-size: 13px; fill: #2c3e50; font-weight: bold;">Key Points:</text>
    <text x="0" y="20" style="font-family: Arial; font-size: 11px; fill: #34495e;">• Phase 1 (Send): User calls OApp → OApp calls Endpoint._lzSend() → Emits PacketSent event</text>
    <text x="0" y="38" style="font-family: Arial; font-size: 11px; fill: #34495e;">• Phase 2 (Verify): DVNs watch PacketSent → Verify on source → Submit verification to destination</text>
    <text x="0" y="56" style="font-family: Arial; font-size: 11px; fill: #34495e;">• Phase 3 (Execute): Executor monitors verification → Calls Endpoint.lzReceive() → Calls OApp._lzReceive()</text>
    <text x="0" y="74" style="font-family: Arial; font-size: 11px; fill: #34495e;">• Nonces: outboundNonce increments on send, lazyInboundNonce validates on receive</text>
    <text x="0" y="92" style="font-family: Arial; font-size: 11px; fill: #34495e;">• Fees: Paid upfront in Phase 1, covers verification (DVNs) + execution (Executor) costs</text>
    <text x="0" y="110" style="font-family: Arial; font-size: 11px; fill: #34495e;">• Atomicity: Each phase is atomic; failures in Phase 3 can be retried without re-verification</text>
  </g>
</svg>
